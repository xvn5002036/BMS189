name: Auto Release BMS189 (GoogleDrive ZIP + Windows)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # 1Ô∏è‚É£ Install gdown (for Windows)
    - name: Install gdown
      run: pip install gdown

    # 2Ô∏è‚É£ Versioning
    - name: Versioning
      id: version
      shell: pwsh
      run: |
        $msg = git log -1 --pretty=%B
        $level = "patch"
        if ($msg -match "MAJOR" -or $msg -match "\[major\]") { $level = "major" }
        elseif ($msg -match "MINOR" -or $msg -match "\[minor\]") { $level = "minor" }

        if (Test-Path "version.txt") {
          $ver = Get-Content version.txt
        } else {
          $ver = "1.0.0"
        }

        $p = $ver.Split(".")
        $major = [int]$p[0]
        $minor = [int]$p[1]
        $patch = [int]$p[2]

        switch ($level) {
          "major" { $major++; $minor = 0; $patch = 0 }
          "minor" { $minor++; $patch = 0 }
          "patch" { $patch++ }
        }

        $new = "$major.$minor.$patch"
        Set-Content version.txt $new
        echo "version=$new" >> $env:GITHUB_ENV

    # 3Ô∏è‚É£ Download server ZIP
    - name: Download server zip
      shell: pwsh
      run: |
        gdown --fuzzy "${{ secrets.SERVER_URL }}" -O BMS189Server_full.zip

    # 4Ô∏è‚É£ Extract server ZIP (Windows supports Chinese filenames!)
    - name: Extract server ZIP
      shell: pwsh
      run: |
        Expand-Archive -LiteralPath "BMS189Server_full.zip" -DestinationPath "server" -Force

    # 5Ô∏è‚É£ Repack
    - name: Repack server ZIP
      shell: pwsh
      run: |
        Compress-Archive -Path server -DestinationPath BMS189Server.zip -Force

    # 6Ô∏è‚É£ Zip update folder
    - name: Zip update
      shell: pwsh
      run: |
        if (Test-Path "update") {
          Compress-Archive -Path update -DestinationPath update.zip -Force
        }

    # 7Ô∏è‚É£ Create Release
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ env.version }}
        files: |
          BMS189Server.zip
          update.zip
          version.txt
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # 8Ô∏è‚É£ Discord notify
    - name: Send Discord message
      shell: pwsh
      run: |
        $VERSION = "${{ env.version }}"
        $RELEASE_URL = "https://github.com/${{ github.repository }}/releases/tag/v$VERSION"
        $MSG = git log -1 --pretty=%B

        $payload = @{
          embeds = @(
            @{
              title = "üöÄ BMS189 Êñ∞ÁâàÊú¨Â∑≤ÁôºÂ∏ÉÔºÅ"
              color = 3447003
              fields = @(
                @{ name = "ÁâàÊú¨Ëôü"; value = "v$VERSION"; inline = $true }
                @{ name = "Êõ¥Êñ∞ÂÖßÂÆπ"; value = $MSG }
                @{ name = "‰∏ãËºâÈÄ£Áµê"; value = $RELEASE_URL }
              )
              footer = @{ text = "BMS189 Ëá™ÂãïÂåñÁôºÂ∏ÉÁ≥ªÁµ±" }
            }
          )
        } | ConvertTo-Json -Depth 10

        Invoke-RestMethod -Uri "${{ secrets.DISCORD_WEBHOOK }}" -Method Post -Body $payload -ContentType "application/json"
