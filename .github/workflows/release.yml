name: Auto Release BMS189 (GoogleDrive Single File)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    # 1️⃣ Install gdown
    - name: Install gdown
      run: pip install gdown

    # 2️⃣ Versioning
    - name: Versioning
      id: version
      run: |
        msg=$(git log -1 --pretty=%B)
        level="patch"
        if [[ "$msg" == *"MAJOR"* ]] || [[ "$msg" == *"[major]"* ]]; then level="major"; fi
        if [[ "$msg" == *"MINOR"* ]] || [[ "$msg" == *"[minor]"* ]]; then level="minor"; fi

        if [[ -f version.txt ]]; then
            ver=$(cat version.txt)
        else
            ver="1.0.0"
        fi

        IFS='.' read -r major minor patch <<< "$ver"
        if [[ "$level" == "major" ]]; then major=$((major+1)); minor=0; patch=0; fi
        if [[ "$level" == "minor" ]]; then minor=$((minor+1)); patch=0; fi
        if [[ "$level" == "patch" ]]; then patch=$((patch+1)); fi

        new="$major.$minor.$patch"
        echo $new > version.txt
        echo "version=$new" >> $GITHUB_ENV

    # 3️⃣ Download the server from Google Drive
    - name: Download server package
      run: |
        gdown "${{ secrets.SERVER_URL }}" -O BMS189Server_full.zip
        echo "Downloaded BMS189Server from Google Drive."

    # 4️⃣ Extract full server
    - name: Extract server
      run: |
        mkdir server
        unzip BMS189Server_full.zip -d server

    # 5️⃣ Repack as Release ZIP
    - name: Repack server
      run: |
        zip -r BMS189Server.zip server

    # 6️⃣ Zip update folder
    - name: Zip update
      run: |
        if [ -d update ]; then
          zip -r update.zip update
        fi

    # 7️⃣ Create Release
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ env.version }}
        files: |
          BMS189Server.zip
          update.zip
          version.txt
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
