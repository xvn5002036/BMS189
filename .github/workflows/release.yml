name: Auto Release BMS189 (GoogleDrive ZIP)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # 1️⃣ 安裝 gdown（支援 Google Drive 大檔）
    - name: Install gdown
      run: pip install gdown

    # 2️⃣ 處理版本號（Major / Minor / Patch）
    - name: Versioning
      run: |
        msg=$(git log -1 --pretty=%B)
        level="patch"
        if [[ "$msg" == *"MAJOR"* ]] || [[ "$msg" == *"[major]"* ]]; then level="major"; fi
        if [[ "$msg" == *"MINOR"* ]] || [[ "$msg" == *"[minor]"* ]]; then level="minor"; fi

        if [[ -f version.txt ]]; then
            ver=$(cat version.txt)
        else
            ver="1.0.0"
        fi

        IFS='.' read -r major minor patch <<< "$ver"
        if [[ "$level" == "major" ]]; then major=$((major+1)); minor=0; patch=0; fi
        if [[ "$level" == "minor" ]]; then minor=$((minor+1)); patch=0; fi
        if [[ "$level" == "patch" ]]; then patch=$((patch+1)); fi

        new="$major.$minor.$patch"
        echo $new > version.txt
        echo "version=$new" >> $GITHUB_ENV

    # 3️⃣ 從 Google Drive 下載 ZIP 服務端
    - name: Download server ZIP from Google Drive
      run: |
        gdown "${{ secrets.SERVER_URL }}" -O BMS189Server_full.zip
        echo "Downloaded server package."

    # 4️⃣ 解壓縮 Server ZIP
    - name: Extract server ZIP
      run: |
        mkdir server
        unzip BMS189Server_full.zip -d server

    # 5️⃣ 重新打包服務端（給 Release 用）
    - name: Repack server ZIP
      run: |
        zip -r BMS189Server.zip server

    # 6️⃣ 打包 update 資料夾
    - name: Zip update folder
      run: |
        if [ -d update ]; then
          zip -r update.zip update
        fi

    # 7️⃣ 發布 GitHub Release
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ env.version }}
        files: |
          BMS189Server.zip
          update.zip
          version.txt
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
